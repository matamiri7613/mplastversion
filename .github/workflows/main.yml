name: Deploy Flask App on Asiatek-2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flask gunicorn
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Deploy to server
      uses: appleboy/ssh-action@master
      with:
        host: '79.127.85.198'
        username: 'root'
        password: '133976beh'
        script: |
          # Create directory if it doesn't exist
          mkdir -p /var/www/flask-app/{templates,static}
          
          # Create virtual environment if it doesn't exist
          if [ ! -d "/var/www/flask-app/venv" ]; then
            python3 -m venv /var/www/flask-app/venv
          fi
          
          # Install requirements
          /var/www/flask-app/venv/bin/pip install --upgrade pip
          /var/www/flask-app/venv/bin/pip install flask gunicorn
          
          # Use existing requirements.txt or create default
          if [ ! -f "/var/www/flask-app/requirements.txt" ]; then
            echo "flask\ngunicorn" > /var/www/flask-app/requirements.txt
          fi
          /var/www/flask-app/venv/bin/pip install -r /var/www/flask-app/requirements.txt

    - name: Copy application files
      uses: appleboy/scp-action@master
      with:
        host: '79.127.85.198'
        username: 'root'
        password: '133976beh'
        source: "*.py,templates/*,static/*,*.json"
        target: "/var/www/flask-app"
        strip_components: 0

    - name: Configure and start services
      uses: appleboy/ssh-action@master
      with:
        host: '79.127.85.198'
        username: 'root'
        password: '133976beh'
        script: |
          # Create systemd service
          cat > /etc/systemd/system/flask-app.service << 'EOL'
          [Unit]
          Description=Flask App Service
          After=network.target
          
          [Service]
          User=root
          WorkingDirectory=/var/www/flask-app
          Environment="PATH=/var/www/flask-app/venv/bin"
          ExecStart=/var/www/flask-app/venv/bin/gunicorn app:app -b 127.0.0.1:8000
          Restart=always
          
          [Install]
          WantedBy=multi-user.target
          EOL
          
          systemctl daemon-reload
          systemctl enable flask-app
          systemctl restart flask-app
          
          # Configure Nginx
          cat > /etc/nginx/sites-available/flask-app << 'EOL'
          server {
              listen 80;
              server_name 79.127.85.198;
              
              location / {
                  proxy_pass http://127.0.0.1:8000;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
              }
          }
          EOL
          
          ln -sf /etc/nginx/sites-available/flask-app /etc/nginx/sites-enabled/
          nginx -t && systemctl restart nginx
          echo "Deployment completed successfully!"
