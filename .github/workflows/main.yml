name: Deploy Flask App on Asiatek-2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies with retries
      run: |
        function pip_install_with_retry {
          local max_attempts=5
          local attempt=0
          local success=0
          
          until [ $attempt -ge $max_attempts ]
          do
            python -m pip install --upgrade pip --default-timeout=100 && \
            pip install --default-timeout=100 flask gunicorn && \
            if [ -f requirements.txt ]; then pip install --default-timeout=100 -r requirements.txt; fi && \
            success=1 && break
            
            attempt=$((attempt + 1))
            echo "Attempt $attempt failed. Retrying in 5 seconds..."
            sleep 5
          done
          
          if [ $success -eq 0 ]; then
            echo "All pip installation attempts failed"
            exit 1
          fi
        }
        
        pip_install_with_retry

    - name: Copy application files
      uses: appleboy/scp-action@master
      with:
        host: '79.127.85.198'
        username: 'root'
        password: '133976beh'
        source: "*.py,templates/*,static/*,*.json"
        target: "/var/www/flask-app"
        strip_components: 0

    - name: Setup server environment
      uses: appleboy/ssh-action@master
      with:
        host: '79.127.85.198'
        username: 'root'
        password: '133976beh'
        script: |
          # Function to retry pip installations
          pip_install_with_retry() {
            local max_attempts=5
            local attempt=0
            local success=0
            
            until [ $attempt -ge $max_attempts ]
            do
              /var/www/flask-app/venv/bin/pip install --default-timeout=100 --upgrade pip && \
              /var/www/flask-app/venv/bin/pip install --default-timeout=100 flask gunicorn && \
              if [ -f "/var/www/flask-app/requirements.txt" ]; then 
                /var/www/flask-app/venv/bin/pip install --default-timeout=100 -r /var/www/flask-app/requirements.txt
              fi && \
              success=1 && break
              
              attempt=$((attempt + 1))
              echo "Attempt $attempt failed. Retrying in 5 seconds..."
              sleep 5
            done
            
            if [ $success -eq 0 ]; then
              echo "All pip installation attempts failed"
              exit 1
            fi
          }
          
          # Create directory structure
          mkdir -p /var/www/flask-app/{templates,static}
          
          # Setup virtual environment with retries
          if [ ! -d "/var/www/flask-app/venv" ]; then
            python3 -m venv /var/www/flask-app/venv || python3.10 -m venv /var/www/flask-app/venv
          fi
          
          # Install requirements with retry mechanism
          pip_install_with_retry
          
          # Create default requirements if missing
          if [ ! -f "/var/www/flask-app/requirements.txt" ]; then
            echo "flask\ngunic
